<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Azure Permissions Viewer & Cleanup Tool</title>
    <script src="https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0078d4 0%, #005a9e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .auth-section {
            text-align: center;
            padding: 40px;
        }

        .btn {
            background: #0078d4;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background: #005a9e;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 120, 212, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #d13438;
        }

        .btn-danger:hover {
            background: #a72629;
        }

        .btn-success {
            background: #107c10;
        }

        .btn-success:hover {
            background: #0e6b0e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078d4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .controls {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .user-count {
            font-weight: bold;
            color: #333;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .users-table th {
            background: #f5f5f5;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
            position: sticky;
            top: 0;
        }

        .users-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        .users-table tr:hover {
            background: #f9f9f9;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .permission-badge {
            display: inline-block;
            background: #e3f2fd;
            color: #0078d4;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin: 2px;
        }

        .permission-badge.entra {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .permission-badge.azure {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .script-section {
            margin-top: 30px;
            border-top: 2px solid #eee;
            padding-top: 30px;
        }

        .script-options {
            margin-bottom: 20px;
        }

        .script-options label {
            display: block;
            margin: 10px 0;
            cursor: pointer;
        }

        .script-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .error {
            background: #fef0f0;
            border-left: 4px solid #d13438;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #d13438;
        }

        .success {
            background: #f0fef0;
            border-left: 4px solid #107c10;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #107c10;
        }

        .info {
            background: #f0f8ff;
            border-left: 4px solid #0078d4;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            color: #333;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Azure Permissions Viewer & Cleanup Tool</h1>
            <p>Analyze and manage Azure RBAC and Entra ID role assignments</p>
        </div>

        <div class="content">
            <div id="configSection" class="auth-section" style="display: none;">
                <h2>‚öôÔ∏è Azure AD App Configuration</h2>
                <p style="margin: 20px 0; color: #666;">Configure your Azure AD application details below.</p>

                <div style="max-width: 600px; margin: 0 auto; text-align: left;">
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Client ID (Application ID)</label>
                        <input type="text" id="clientId" class="search-box" placeholder="00000000-0000-0000-0000-000000000000" style="width: 100%;">
                    </div>

                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Tenant ID (Directory ID) - Optional</label>
                        <input type="text" id="tenantId" class="search-box" placeholder="common (or your specific tenant ID)" style="width: 100%;">
                        <small style="color: #666;">Leave as 'common' for multi-tenant, or enter your specific tenant ID</small>
                    </div>

                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-success" onclick="saveConfigAndSignIn()">Save & Sign In</button>
                        <button class="btn" onclick="showAuthSection()">Cancel</button>
                    </div>
                </div>

                <div class="info" style="margin-top: 30px; text-align: left;">
                    <strong>üìã How to register an Azure AD application:</strong>
                    <ol style="margin-left: 20px; margin-top: 10px; line-height: 1.6;">
                        <li>Go to <a href="https://portal.azure.com/#view/Microsoft_AAD_IAM/ActiveDirectoryMenuBlade/~/RegisteredApps" target="_blank">Azure Portal ‚Üí Azure Active Directory ‚Üí App registrations</a></li>
                        <li>Click "New registration"</li>
                        <li>Name: "Azure Permissions Viewer" (or any name)</li>
                        <li>Supported account types: "Accounts in this organizational directory only"</li>
                        <li>Redirect URI: Select "Single-page application (SPA)" and enter the URL where you're hosting this file (or file:/// if running locally)</li>
                        <li>Click "Register"</li>
                        <li>Copy the "Application (client) ID" - this is your Client ID</li>
                        <li>Copy the "Directory (tenant) ID" - this is your Tenant ID</li>
                        <li>Go to "API permissions" ‚Üí "Add a permission"</li>
                        <li>Select "Microsoft Graph" ‚Üí "Delegated permissions"</li>
                        <li>Add these permissions: <code>Directory.Read.All</code>, <code>User.Read.All</code>, <code>RoleManagement.Read.Directory</code></li>
                        <li>Select "Azure Service Management" ‚Üí "Delegated permissions"</li>
                        <li>Add: <code>user_impersonation</code></li>
                        <li>Click "Grant admin consent" (requires admin privileges)</li>
                    </ol>
                </div>
            </div>

            <div id="authSection" class="auth-section">
                <h2>Sign in to Azure</h2>
                <p style="margin: 20px 0; color: #666;">Click the button below to authenticate with your Azure account.</p>
                <button class="btn" onclick="signIn()">Sign In with Microsoft</button>
                <button class="btn" onclick="showConfigSection()" style="background: #6c757d;">‚öôÔ∏è Configure App</button>
                <div class="info" style="margin-top: 20px; text-align: left;">
                    <strong>‚ö†Ô∏è First Time Setup Required:</strong>
                    <p style="margin: 10px 0;">You need to register your own Azure AD application to use this tool. Click "Configure App" above for instructions.</p>
                    <strong>Required Permissions:</strong>
                    <ul style="margin-left: 20px; margin-top: 10px;">
                        <li>Directory.Read.All (to read Entra ID roles)</li>
                        <li>User.Read.All (to read user information)</li>
                        <li>Reader access to Azure subscriptions (to read RBAC assignments)</li>
                    </ul>
                </div>
            </div>

            <div id="loadingSection" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p id="loadingMessage">Loading permissions data...</p>
            </div>

            <div id="mainSection" style="display: none;">
                <div class="controls">
                    <input type="text" class="search-box" id="searchBox" placeholder="Search by name, email, or permission..." onkeyup="filterUsers()">
                    <div>
                        <span class="user-count" id="userCount">0 users</span>
                        <button class="btn btn-success" onclick="loadPermissions()" style="margin-left: 10px;">üîÑ Refresh</button>
                        <button class="btn btn-danger" onclick="signOut()">Sign Out</button>
                    </div>
                </div>

                <div class="info">
                    <strong>Instructions:</strong> Select users you want to clean up, configure the cleanup options below, and copy the generated script to Azure Cloud Shell.
                </div>

                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th><input type="checkbox" class="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Azure RBAC Permissions</th>
                                <th>Entra ID Roles</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <!-- Users will be populated here -->
                        </tbody>
                    </table>
                </div>

                <div class="script-section">
                    <h2>Cleanup Script Generator</h2>

                    <div class="script-options">
                        <h3>Script Type:</h3>
                        <label>
                            <input type="radio" name="scriptType" value="powershell" checked onchange="generateScript()">
                            PowerShell (Az module)
                        </label>
                        <label>
                            <input type="radio" name="scriptType" value="cli" onchange="generateScript()">
                            Azure CLI (bash)
                        </label>

                        <h3 style="margin-top: 20px;">Options:</h3>
                        <label>
                            <input type="checkbox" id="deleteFromEntra" onchange="generateScript()">
                            Delete users from Entra ID (permanent deletion)
                        </label>
                        <label>
                            <input type="checkbox" id="includeComments" checked onchange="generateScript()">
                            Include comments in script
                        </label>
                    </div>

                    <div style="margin-bottom: 10px;">
                        <strong>Selected users: <span id="selectedCount">0</span></strong>
                    </div>

                    <button class="btn" onclick="copyScript()">üìã Copy Script to Clipboard</button>

                    <div id="scriptOutput" class="script-output" style="margin-top: 15px;">
                        # Select users above to generate a cleanup script
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration Management
        function getStoredConfig() {
            const clientId = localStorage.getItem('azureClientId');
            const tenantId = localStorage.getItem('azureTenantId') || 'common';
            return { clientId, tenantId };
        }

        function saveConfig(clientId, tenantId) {
            localStorage.setItem('azureClientId', clientId);
            localStorage.setItem('azureTenantId', tenantId || 'common');
        }

        function showConfigSection() {
            const config = getStoredConfig();
            document.getElementById('clientId').value = config.clientId || '';
            document.getElementById('tenantId').value = config.tenantId || 'common';
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('configSection').style.display = 'block';
        }

        function showAuthSection() {
            document.getElementById('configSection').style.display = 'none';
            document.getElementById('authSection').style.display = 'block';
        }

        function saveConfigAndSignIn() {
            const clientId = document.getElementById('clientId').value.trim();
            const tenantId = document.getElementById('tenantId').value.trim() || 'common';

            if (!clientId) {
                alert('Please enter a Client ID');
                return;
            }

            // Validate GUID format
            const guidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
            if (!guidRegex.test(clientId)) {
                alert('Please enter a valid Client ID (GUID format)');
                return;
            }

            saveConfig(clientId, tenantId);

            // Reload the page to reinitialize MSAL with new config
            window.location.reload();
        }

        // MSAL Configuration
        const config = getStoredConfig();

        if (!config.clientId) {
            // Show config section on first load if no config exists
            document.addEventListener('DOMContentLoaded', () => {
                showConfigSection();
            });
        }

        const msalConfig = {
            auth: {
                clientId: config.clientId || "00000000-0000-0000-0000-000000000000",
                authority: `https://login.microsoftonline.com/${config.tenantId}`,
                redirectUri: window.location.href.split('?')[0].split('#')[0]
            },
            cache: {
                cacheLocation: "sessionStorage",
                storeAuthStateInCookie: false
            }
        };

        // Initial login request - only Microsoft Graph scopes
        // Azure Management scopes will be requested separately when needed
        const loginRequest = {
            scopes: [
                "https://graph.microsoft.com/Directory.Read.All",
                "https://graph.microsoft.com/User.Read.All",
                "https://graph.microsoft.com/RoleManagement.Read.Directory"
            ]
        };

        let msalInstance = null;
        let accessToken = null;
        let graphToken = null;
        let usersData = [];
        let allUsersData = [];

        // Initialize MSAL
        if (config.clientId) {
            msalInstance = new msal.PublicClientApplication(msalConfig);
            msalInstance.initialize().then(() => {
                msalInstance.handleRedirectPromise().then(handleResponse).catch(err => {
                    console.error(err);
                    showError("Authentication failed: " + (err.message || err));
                });
            }).catch(err => {
                console.error("MSAL initialization failed:", err);
                showError("Failed to initialize authentication: " + err.message);
            });
        }

        function handleResponse(response) {
            if (response !== null) {
                accessToken = response.accessToken;
                showMainSection();
            }
        }

        async function signIn() {
            if (!msalInstance) {
                showConfigSection();
                showError("Please configure your Azure AD application first.");
                return;
            }

            try {
                await msalInstance.loginRedirect(loginRequest);
            } catch (error) {
                console.error("Login error:", error);
                showError("Failed to sign in: " + error.message);
            }
        }

        async function signOut() {
            const logoutRequest = {
                account: msalInstance.getAllAccounts()[0]
            };
            await msalInstance.logoutRedirect(logoutRequest);
        }

        async function getToken(scopes) {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length === 0) {
                await signIn();
                return null;
            }

            const request = {
                scopes: scopes,
                account: accounts[0]
            };

            try {
                const response = await msalInstance.acquireTokenSilent(request);
                return response.accessToken;
            } catch (error) {
                console.error("Silent token acquisition failed, using redirect");
                await msalInstance.acquireTokenRedirect(request);
                return null;
            }
        }

        function showMainSection() {
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
            loadPermissions();
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingSection').style.display = 'block';
            document.getElementById('mainSection').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('mainSection').style.display = 'block';
        }

        function showError(message) {
            // Try to find a visible section to show the error
            let targetSection = document.getElementById('mainSection');
            if (targetSection.style.display === 'none' || !targetSection.style.display) {
                targetSection = document.getElementById('authSection').style.display !== 'none'
                    ? document.getElementById('authSection')
                    : document.getElementById('configSection');
            }

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;

            if (targetSection.firstChild) {
                targetSection.insertBefore(errorDiv, targetSection.firstChild);
            } else {
                targetSection.appendChild(errorDiv);
            }

            setTimeout(() => errorDiv.remove(), 10000);
        }

        async function loadPermissions() {
            showLoading('Loading permissions data...');

            try {
                // Get tokens
                graphToken = await getToken(["https://graph.microsoft.com/Directory.Read.All", "https://graph.microsoft.com/User.Read.All"]);
                accessToken = await getToken(["https://management.azure.com/user_impersonation"]);

                if (!graphToken || !accessToken) {
                    throw new Error("Failed to acquire tokens");
                }

                // Fetch data in parallel
                const [users, entraRoles, subscriptions] = await Promise.all([
                    fetchAllUsers(),
                    fetchEntraIDRoles(),
                    fetchSubscriptions()
                ]);

                showLoading('Loading Azure RBAC assignments...');
                const rbacAssignments = await fetchAllRBACAssignments(subscriptions);

                showLoading('Processing permissions...');
                usersData = processPermissionsData(users, entraRoles, rbacAssignments);
                allUsersData = [...usersData];

                renderUsers();
                hideLoading();
            } catch (error) {
                console.error("Error loading permissions:", error);
                hideLoading();
                showError("Failed to load permissions: " + error.message);
            }
        }

        async function fetchAllUsers() {
            let users = [];
            let url = "https://graph.microsoft.com/v1.0/users?$select=id,displayName,userPrincipalName,userType,accountEnabled&$top=999";

            while (url) {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${graphToken}` }
                });

                if (!response.ok) throw new Error(`Failed to fetch users: ${response.statusText}`);

                const data = await response.json();
                users = users.concat(data.value);
                url = data['@odata.nextLink'];
            }

            return users;
        }

        async function fetchEntraIDRoles() {
            const roleAssignments = [];

            // Get directory roles
            const rolesResponse = await fetch("https://graph.microsoft.com/v1.0/directoryRoles?$expand=members", {
                headers: { 'Authorization': `Bearer ${graphToken}` }
            });

            if (!rolesResponse.ok) throw new Error(`Failed to fetch Entra ID roles: ${rolesResponse.statusText}`);

            const rolesData = await rolesResponse.json();

            for (const role of rolesData.value) {
                if (role.members) {
                    for (const member of role.members) {
                        roleAssignments.push({
                            userId: member.id,
                            roleId: role.id,
                            roleName: role.displayName,
                            roleTemplateId: role.roleTemplateId
                        });
                    }
                }
            }

            // Also fetch PIM eligible assignments if possible
            try {
                const pimResponse = await fetch("https://graph.microsoft.com/v1.0/roleManagement/directory/roleEligibilityScheduleInstances?$expand=principal,roleDefinition", {
                    headers: { 'Authorization': `Bearer ${graphToken}` }
                });

                if (pimResponse.ok) {
                    const pimData = await pimResponse.json();
                    for (const assignment of pimData.value) {
                        if (assignment.principal && assignment.roleDefinition) {
                            roleAssignments.push({
                                userId: assignment.principal.id,
                                roleId: assignment.roleDefinition.id,
                                roleName: assignment.roleDefinition.displayName + " (Eligible)",
                                roleTemplateId: assignment.roleDefinition.templateId,
                                isPIM: true
                            });
                        }
                    }
                }
            } catch (e) {
                console.log("PIM roles not accessible:", e);
            }

            return roleAssignments;
        }

        async function fetchSubscriptions() {
            const response = await fetch("https://management.azure.com/subscriptions?api-version=2020-01-01", {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });

            if (!response.ok) throw new Error(`Failed to fetch subscriptions: ${response.statusText}`);

            const data = await response.json();
            return data.value;
        }

        async function fetchAllRBACAssignments(subscriptions) {
            const allAssignments = [];

            for (const subscription of subscriptions) {
                try {
                    let url = `https://management.azure.com${subscription.id}/providers/Microsoft.Authorization/roleAssignments?api-version=2022-04-01&$filter=atScope()`;

                    while (url) {
                        const response = await fetch(url, {
                            headers: { 'Authorization': `Bearer ${accessToken}` }
                        });

                        if (!response.ok) {
                            console.warn(`Failed to fetch RBAC for subscription ${subscription.displayName}`);
                            break;
                        }

                        const data = await response.json();

                        for (const assignment of data.value) {
                            allAssignments.push({
                                ...assignment,
                                subscriptionId: subscription.id,
                                subscriptionName: subscription.displayName
                            });
                        }

                        url = data.nextLink;
                    }
                } catch (error) {
                    console.error(`Error fetching RBAC for subscription ${subscription.displayName}:`, error);
                }
            }

            return allAssignments;
        }

        function processPermissionsData(users, entraRoles, rbacAssignments) {
            const userMap = new Map();

            // Initialize users
            for (const user of users) {
                userMap.set(user.id, {
                    id: user.id,
                    displayName: user.displayName,
                    userPrincipalName: user.userPrincipalName,
                    userType: user.userType,
                    accountEnabled: user.accountEnabled,
                    entraRoles: [],
                    azureRoles: [],
                    selected: false
                });
            }

            // Add Entra ID roles
            for (const roleAssignment of entraRoles) {
                const user = userMap.get(roleAssignment.userId);
                if (user) {
                    user.entraRoles.push({
                        name: roleAssignment.roleName,
                        id: roleAssignment.roleId,
                        templateId: roleAssignment.roleTemplateId,
                        isPIM: roleAssignment.isPIM || false
                    });
                }
            }

            // Add Azure RBAC roles
            for (const assignment of rbacAssignments) {
                // Extract user ID from principalId
                const principalId = assignment.properties.principalId;
                const user = userMap.get(principalId);

                if (user) {
                    user.azureRoles.push({
                        roleDefinitionId: assignment.properties.roleDefinitionId,
                        scope: assignment.properties.scope,
                        assignmentId: assignment.id,
                        subscriptionName: assignment.subscriptionName
                    });
                }
            }

            // Filter to only users with permissions
            return Array.from(userMap.values()).filter(u =>
                u.entraRoles.length > 0 || u.azureRoles.length > 0
            );
        }

        function summarizeAzureRoles(azureRoles) {
            if (azureRoles.length === 0) return [];

            const roleCounts = {};

            for (const role of azureRoles) {
                const roleName = getRoleName(role.roleDefinitionId);
                const scopeType = getScopeType(role.scope);
                const key = `${roleName}:${scopeType}`;

                if (!roleCounts[key]) {
                    roleCounts[key] = { roleName, scopeType, count: 0 };
                }
                roleCounts[key].count++;
            }

            return Object.values(roleCounts);
        }

        function getRoleName(roleDefinitionId) {
            const parts = roleDefinitionId.split('/');
            const roleId = parts[parts.length - 1];

            const knownRoles = {
                '8e3af657-a8ff-443c-a75c-2fe8c4bcb635': 'Owner',
                'b24988ac-6180-42a0-ab88-20f7382dd24c': 'Contributor',
                'acdd72a7-3385-48ef-bd42-f606fba81ae7': 'Reader',
                '18d7d88d-d35e-4fb5-a5c3-7773c20a72d9': 'User Access Administrator',
            };

            return knownRoles[roleId] || 'Custom Role';
        }

        function getScopeType(scope) {
            if (scope.includes('/resourceGroups/')) return 'Resource Group';
            if (scope.includes('/providers/')) return 'Resource';
            if (scope.match(/\/subscriptions\/[^/]+$/)) return 'Subscription';
            return 'Management Group';
        }

        function renderUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            usersData.forEach(user => {
                const tr = document.createElement('tr');

                const azureRolesSummary = summarizeAzureRoles(user.azureRoles);

                tr.innerHTML = `
                    <td><input type="checkbox" class="checkbox user-checkbox" data-user-id="${user.id}" ${user.selected ? 'checked' : ''} onchange="toggleUser('${user.id}')"></td>
                    <td>${escapeHtml(user.displayName)}</td>
                    <td>${escapeHtml(user.userPrincipalName)}</td>
                    <td>
                        ${azureRolesSummary.map(r =>
                            `<span class="permission-badge azure">${escapeHtml(r.roleName)} (${r.count} ${escapeHtml(r.scopeType)}${r.count > 1 ? 's' : ''})</span>`
                        ).join('')}
                        ${azureRolesSummary.length === 0 ? '<span style="color: #999;">None</span>' : ''}
                    </td>
                    <td>
                        ${user.entraRoles.map(r =>
                            `<span class="permission-badge entra">${escapeHtml(r.name)}</span>`
                        ).join('')}
                        ${user.entraRoles.length === 0 ? '<span style="color: #999;">None</span>' : ''}
                    </td>
                `;

                tbody.appendChild(tr);
            });

            updateUserCount();
            generateScript();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll').checked;
            usersData.forEach(user => user.selected = selectAll);
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = selectAll);
            generateScript();
        }

        function toggleUser(userId) {
            const user = usersData.find(u => u.id === userId);
            if (user) {
                user.selected = !user.selected;
                generateScript();
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchBox').value.toLowerCase();

            if (!searchTerm) {
                usersData = [...allUsersData];
            } else {
                usersData = allUsersData.filter(user => {
                    const matchName = user.displayName.toLowerCase().includes(searchTerm);
                    const matchEmail = user.userPrincipalName.toLowerCase().includes(searchTerm);
                    const matchEntraRole = user.entraRoles.some(r => r.name.toLowerCase().includes(searchTerm));
                    const matchAzureRole = user.azureRoles.some(r => getRoleName(r.roleDefinitionId).toLowerCase().includes(searchTerm));

                    return matchName || matchEmail || matchEntraRole || matchAzureRole;
                });
            }

            renderUsers();
        }

        function updateUserCount() {
            document.getElementById('userCount').textContent = `${usersData.length} user${usersData.length !== 1 ? 's' : ''}`;
        }

        function generateScript() {
            const selectedUsers = allUsersData.filter(u => u.selected);
            const scriptType = document.querySelector('input[name="scriptType"]:checked').value;
            const deleteFromEntra = document.getElementById('deleteFromEntra').checked;
            const includeComments = document.getElementById('includeComments').checked;

            document.getElementById('selectedCount').textContent = selectedUsers.length;

            if (selectedUsers.length === 0) {
                document.getElementById('scriptOutput').textContent = '# Select users above to generate a cleanup script';
                return;
            }

            let script = '';

            if (scriptType === 'powershell') {
                script = generatePowerShellScript(selectedUsers, deleteFromEntra, includeComments);
            } else {
                script = generateAzureCLIScript(selectedUsers, deleteFromEntra, includeComments);
            }

            document.getElementById('scriptOutput').textContent = script;
        }

        function generatePowerShellScript(selectedUsers, deleteFromEntra, includeComments) {
            let script = '';

            if (includeComments) {
                script += `# Azure Permissions Cleanup Script (PowerShell)
# Generated: ${new Date().toISOString()}
# Selected users: ${selectedUsers.length}
#
# Prerequisites:
# - Az PowerShell module installed (Install-Module -Name Az)
# - Connected to Azure (Connect-AzAccount)
# - Sufficient permissions to remove role assignments and delete users
#
# WARNING: This script will permanently remove role assignments${deleteFromEntra ? ' and DELETE users from Entra ID' : ''}.
# Review carefully before executing!

`;
            }

            for (const user of selectedUsers) {
                if (includeComments) {
                    script += `\n# ===== ${user.displayName} (${user.userPrincipalName}) =====\n`;
                }

                // Remove Azure RBAC assignments
                if (user.azureRoles.length > 0) {
                    if (includeComments) {
                        script += `# Remove Azure RBAC assignments (${user.azureRoles.length} assignment${user.azureRoles.length !== 1 ? 's' : ''})\n`;
                    }

                    for (const role of user.azureRoles) {
                        script += `Remove-AzRoleAssignment -ObjectId "${user.id}" -Scope "${role.scope}" -RoleDefinitionId "${role.roleDefinitionId}"\n`;
                    }
                }

                // Remove Entra ID roles
                if (user.entraRoles.length > 0) {
                    if (includeComments) {
                        script += `# Remove Entra ID roles (${user.entraRoles.length} role${user.entraRoles.length !== 1 ? 's' : ''})\n`;
                    }

                    for (const role of user.entraRoles.filter(r => !r.isPIM)) {
                        script += `Remove-AzureADDirectoryRoleMember -ObjectId "${role.id}" -MemberId "${user.id}"\n`;
                    }

                    const pimRoles = user.entraRoles.filter(r => r.isPIM);
                    if (pimRoles.length > 0 && includeComments) {
                        script += `# Note: PIM eligible roles must be removed through Azure Portal or Microsoft Graph API\n`;
                    }
                }

                // Delete user from Entra ID
                if (deleteFromEntra) {
                    if (includeComments) {
                        script += `# Delete user from Entra ID\n`;
                    }
                    script += `Remove-AzureADUser -ObjectId "${user.id}"\n`;
                }
            }

            if (includeComments) {
                script += `\n# Cleanup complete!\n`;
            }

            return script;
        }

        function generateAzureCLIScript(selectedUsers, deleteFromEntra, includeComments) {
            let script = '';

            if (includeComments) {
                script += `#!/bin/bash
# Azure Permissions Cleanup Script (Azure CLI)
# Generated: ${new Date().toISOString()}
# Selected users: ${selectedUsers.length}
#
# Prerequisites:
# - Azure CLI installed
# - Logged in to Azure (az login)
# - Sufficient permissions to remove role assignments and delete users
#
# WARNING: This script will permanently remove role assignments${deleteFromEntra ? ' and DELETE users from Entra ID' : ''}.
# Review carefully before executing!

`;
            }

            for (const user of selectedUsers) {
                if (includeComments) {
                    script += `\n# ===== ${user.displayName} (${user.userPrincipalName}) =====\n`;
                }

                // Remove Azure RBAC assignments
                if (user.azureRoles.length > 0) {
                    if (includeComments) {
                        script += `# Remove Azure RBAC assignments (${user.azureRoles.length} assignment${user.azureRoles.length !== 1 ? 's' : ''})\n`;
                    }

                    for (const role of user.azureRoles) {
                        const assignmentId = role.assignmentId.replace(/^\//, '');
                        script += `az role assignment delete --ids "/${assignmentId}"\n`;
                    }
                }

                // Remove Entra ID roles
                if (user.entraRoles.length > 0) {
                    if (includeComments) {
                        script += `# Remove Entra ID roles (${user.entraRoles.length} role${user.entraRoles.length !== 1 ? 's' : ''})\n`;
                    }

                    for (const role of user.entraRoles.filter(r => !r.isPIM)) {
                        script += `az rest --method DELETE --url "https://graph.microsoft.com/v1.0/directoryRoles/${role.id}/members/${user.id}/\\$ref"\n`;
                    }

                    const pimRoles = user.entraRoles.filter(r => r.isPIM);
                    if (pimRoles.length > 0 && includeComments) {
                        script += `# Note: PIM eligible roles must be removed through Azure Portal or Microsoft Graph API\n`;
                    }
                }

                // Delete user from Entra ID
                if (deleteFromEntra) {
                    if (includeComments) {
                        script += `# Delete user from Entra ID\n`;
                    }
                    script += `az ad user delete --id "${user.id}"\n`;
                }
            }

            if (includeComments) {
                script += `\n# Cleanup complete!\n`;
            }

            return script;
        }

        function copyScript() {
            const scriptText = document.getElementById('scriptOutput').textContent;

            if (scriptText === '# Select users above to generate a cleanup script') {
                showError('Please select users first');
                return;
            }

            navigator.clipboard.writeText(scriptText).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '‚úì Copied!';
                btn.style.background = '#107c10';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                }, 2000);
            }).catch(err => {
                showError('Failed to copy to clipboard: ' + err.message);
            });
        }
    </script>
</body>
</html>
